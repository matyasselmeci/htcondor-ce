#!/usr/bin/make -f
echo:=@echo
echotbl:=@printf "%-40s %s\n"

EXTRA_ARGS:=
SHELL:=bash

VERSION := $(shell rpmspec --srpm -q --queryformat '%{version}\n' rpm/htcondor-ce.spec 2>/dev/null)
HASH := $(shell git rev-parse HEAD)
NAME = htcondor-ce
NAME_VERSION = $(NAME)-$(VERSION)

.PHONY: help
help:
	$(echo) "Targets:"
	$(echo)
	$(echotbl) "rpmbuild"  "Run a local RPM build"
	$(echotbl) "uwrpmbuild" "Run a local RPM build, uw_build style"
	$(echotbl) "kojiscratch" "Run a koji scratch build"
	$(echo)
#	$(echo) "Variables:"
#	$(echo)
#	$(echotbl) "EXTRA_ARGS"  "Arbitrary extra arguments [$(EXTRA_ARGS)]"


upstream/test.source: .git/index
	mkdir -p upstream
	echo "type=git url=. name=$(NAME) tag=HEAD tarball=$(NAME_VERSION).tar.gz hash=$(HASH)" > upstream/test.source

rpmbuild: upstream/test.source
	osg-build rpmbuild

uwrpmbuild: upstream/test.source
	osg-build prebuild
	rpmbuild -Ddist\ .uw -Duw_build\ 1 -Dosg\ 0 -Del7\ 1 -Drhel\ 7 --rebuild _final_srpm_contents/*.src.rpm

kojiscratch: upstream/test.source
	osg-build koji --scratch --getfiles

.PHONY: rpmbuild kojiscratch
